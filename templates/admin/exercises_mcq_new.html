{% extends "base.html" %}

{% block title %}{{ t('Nuevo ejercicio – MCQ', 'New Exercise – MCQ', app_lang) }} · ProfePanda{% endblock %}

{% block head %}
  {{ super() }}
  {% include "_ppx_head_assets.html" %}
{% endblock %}

{% block admin_nav %}{% include "_admin_bar.html" %}{% endblock %}

{% block content %}
  <section class="ppx-container" style="padding-top:0;">
    <div class="ppx-row" style="justify-content:flex-end;margin:8px 0 12px 0;">
      <a class="ppx-btn ppx-btn--subtle" href="{{ url_for('admin.admin_exercises_index') }}">{{ t('Volver a Ejercicios', 'Back to Exercises', app_lang) }}</a>
    </div>
    <header class="ppx-row" style="align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;">
      <h1 style="margin:0;">{{ t('Ejercicio: MCQ', 'Exercise: MCQ', app_lang) }}</h1>
      <div class="ppx-chip">{{ t('Constructor', 'Builder', app_lang) }}</div>
    </header>

    <form id="ppx-mcq-form" class="ppx-card" style="margin-bottom:12px; padding:20px; max-width:1000px;"
          data-builder-mode="{{ builder_mode|default('new') }}"
          data-builder-slug="{{ builder_slug|default('') }}">
      <div class="ppx-col" style="gap:16px;">
        <div class="ppx-field">
          <label for="ex-slug">{{ t('Slug', 'Slug', app_lang) }}</label>
          <input id="ex-slug" name="slug" class="ppx-input" placeholder="mcq-ser-estar" autocomplete="off">
          <div class="ppx-field__help">{{ t('Usá minúsculas y guiones. No uses espacios.', 'Use lowercase and hyphens. No spaces.', app_lang) }}</div>
        </div>

        <div class="ppx-field">
          <label for="ex-title-es">{{ t('Título (ES)', 'Title (ES)', app_lang) }}</label>
          <input id="ex-title-es" name="title_es" class="ppx-input" placeholder="SER o ESTAR: adjetivos" autocomplete="off">
        </div>

        <div class="ppx-field">
          <label for="ex-title-en">{{ t('Título (EN)', 'Title (EN)', app_lang) }}</label>
          <input id="ex-title-en" name="title_en" class="ppx-input" placeholder="SER or ESTAR: adjectives" autocomplete="off">
        </div>

        <div class="ppx-field">
          <label for="ex-inst-es">{{ t('Instrucciones (ES)', 'Instructions (ES)', app_lang) }}</label>
          <textarea id="ex-inst-es" name="instructions_es" class="ppx-textarea" rows="3" placeholder="{{ t('Seleccioná la(s) opción(es) correcta(s).', 'Select the correct option(s).', app_lang) }}"></textarea>
        </div>

        <div class="ppx-field">
          <label for="ex-inst-en">{{ t('Instrucciones (EN)', 'Instructions (EN)', app_lang) }}</label>
          <textarea id="ex-inst-en" name="instructions_en" class="ppx-textarea" rows="3" placeholder="Select the correct option(s)."></textarea>
        </div>

        <div class="ppx-row" style="gap:12px; flex-wrap:wrap; max-width:1000px;">
          <div class="ppx-field" style="flex:0 0 200px;">
            <label for="ex-level">{{ t('Nivel', 'Level', app_lang) }}</label>
            <select id="ex-level" name="level" class="ppx-select">
              <option value="A1">A1</option><option value="A2" selected>A2</option>
              <option value="B1">B1</option><option value="B2">B2</option>
              <option value="C1">C1</option><option value="C2">C2</option>
            </select>
          </div>
          <div class="ppx-field" style="flex:1; max-width:780px;">
            <label class="ppx-label">{{ t('Temas gramaticales', 'Grammar topics', app_lang) }}</label>
            <div class="ppx-taxonomy" data-lang="{{ (app_lang or 'es')|lower }}">
              <input type='hidden' id='taxonomy_paths' name='taxonomy_paths' value='{{ []|tojson }}'>
            </div>
            <div class="ppx-muted" style="margin-top:.5rem;">
              {{ t('Seleccione uno o más temas para clasificar este ejercicio.', 'Select one or more topics to categorize this exercise.', app_lang) }}
            </div>
          </div>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid var(--ppx-line);margin:16px 0;">

      <div class="ppx-col" id="ppx-items" style="gap:12px; max-width:1000px;">
        <div class="ppx-row" style="align-items:center; justify-content:space-between; gap:16px;">
          <h2 style="margin:.25rem 0;">{{ t('Ítems', 'Items', app_lang) }}</h2>
          <button id="ppx-add-item" type="button" class="ppx-btn ppx-btn--primary">{{ t('Agregar ítem', 'Add item', app_lang) }}</button>
        </div>

        <template id="ppx-item-template">
          <details class="ppx-card" open style="padding:12px; max-width:1000px;">
            <summary style="cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px;">
              <span class="ppx-chip" data-item-handle>#1</span>
              <strong class="ppx-item-title" style="flex:1;">{{ t('Nuevo ítem', 'New item', app_lang) }}</strong>
              <button type="button" class="ppx-btn ppx-btn--ghost" data-item-up title="{{ t('Subir', 'Move up', app_lang) }}">
                <img src="{{ url_for('static', filename='assets/icons/up.svg') }}" alt="" aria-hidden="true" style="width:18px;height:18px;vertical-align:middle;">
                <span class="ppx-visually-hidden">{{ t('Subir', 'Move up', app_lang) }}</span>
              </button>
              <button type="button" class="ppx-btn ppx-btn--ghost" data-item-down title="{{ t('Bajar', 'Move down', app_lang) }}">
                <img src="{{ url_for('static', filename='assets/icons/down.svg') }}" alt="" aria-hidden="true" style="width:18px;height:18px;vertical-align:middle;">
                <span class="ppx-visually-hidden">{{ t('Bajar', 'Move down', app_lang) }}</span>
              </button>
              <button type="button" class="ppx-btn" data-item-dup title="{{ t('Duplicar', 'Duplicate', app_lang) }}">
                <img src="{{ url_for('static', filename='assets/icons/duplicate.svg') }}" alt="" aria-hidden="true" style="width:18px;height:18px;vertical-align:middle;">
                <span class="ppx-visually-hidden">{{ t('Duplicar', 'Duplicate', app_lang) }}</span>
              </button>
              <button type="button" class="ppx-btn" data-item-del title="{{ t('Eliminar', 'Delete', app_lang) }}">
                <img src="{{ url_for('static', filename='assets/icons/delete.svg') }}" alt="" aria-hidden="true" style="width:18px;height:18px;vertical-align:middle;">
                <span class="ppx-visually-hidden">{{ t('Eliminar', 'Delete', app_lang) }}</span>
              </button>
            </summary>

            <div class="ppx-col" style="gap:12px; margin-top:10px;">
              <!-- Media panel injected by JS (upload/list) -->

              <div class="ppx-field">
                <label>{{ t('Pregunta (ES)', 'Question (ES)', app_lang) }}</label>
                <textarea class="ppx-textarea" data-field="question_es" rows="2"></textarea>
              </div>
              <div class="ppx-field">
                <label>{{ t('Pregunta (EN)', 'Question (EN)', app_lang) }}</label>
                <textarea class="ppx-textarea" data-field="question_en" rows="2"></textarea>
              </div>

              <div class="ppx-field">
                <label>{{ t('Pista (opcional) - ES', 'Hint (optional) - ES', app_lang) }}</label>
                <textarea class="ppx-textarea" data-field="hint_es" rows="2"></textarea>
              </div>
              <div class="ppx-field">
                <label>{{ t('Pista (opcional) - EN', 'Hint (optional) - EN', app_lang) }}</label>
                <textarea class="ppx-textarea" data-field="hint_en" rows="2"></textarea>
              </div>

              <div class="ppx-col" data-opts style="gap:8px;">
                <div class="ppx-row" style="align-items:center; justify-content:space-between;">
                  <h3 style="margin:.25rem 0;">{{ t('Opciones', 'Options', app_lang) }}</h3>
                  <button type="button" class="ppx-btn" data-add-opt>{{ t('Agregar opción', 'Add option', app_lang) }}</button>
                </div>
                <div class="ppx-col" data-opts-list style="gap:8px;"></div>
              </div>
            </div>
          </details>
        </template>

        <template id="ppx-option-template">
          <div class="ppx-card" style="padding:10px;">
            <div class="ppx-row" style="gap:10px; align-items:center;">
              <span class="ppx-chip" style="cursor:grab; user-select:none;" title="{{ t('Arrastrar', 'Drag', app_lang) }}">⋮⋮</span>
              <label style="display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-opt-correct>
                <span>{{ t('Correcta', 'Correct', app_lang) }}</span>
              </label>
              <div class="ppx-row" style="gap:6px; margin-left:auto;">
                <button type="button" class="ppx-btn ppx-btn--ghost" data-opt-up title="{{ t('Subir', 'Move up', app_lang) }}">▲</button>
                <button type="button" class="ppx-btn ppx-btn--ghost" data-opt-down title="{{ t('Bajar', 'Move down', app_lang) }}">▼</button>
                <button type="button" class="ppx-btn ppx-btn--danger" data-opt-del>{{ t('Quitar', 'Remove', app_lang) }}</button>
              </div>
            </div>
            <div class="ppx-row" style="gap:12px; margin-top:8px; flex-wrap:wrap;">
              <div class="ppx-field" style="flex:1; min-width:220px;">
                <label>{{ t('Texto (ES)', 'Text (ES)', app_lang) }}</label>
                <input class="ppx-input" data-opt-text-es>
              </div>
              <div class="ppx-field" style="flex:1; min-width:220px;">
                <label>{{ t('Texto (EN)', 'Text (EN)', app_lang) }}</label>
                <input class="ppx-input" data-opt-text-en>
              </div>
            </div>
            <div class="ppx-row" style="gap:12px; margin-top:8px; flex-wrap:wrap;">
              <div class="ppx-field" style="flex:1; min-width:220px;">
                <label>{{ t('Feedback (ES)', 'Feedback (ES)', app_lang) }}</label>
                <input class="ppx-input" data-opt-fb-es>
              </div>
              <div class="ppx-field" style="flex:1; min-width:220px;">
                <label>{{ t('Feedback (EN)', 'Feedback (EN)', app_lang) }}</label>
                <input class="ppx-input" data-opt-fb-en>
              </div>
            </div>
          </div>
        </template>
      </div>

      <script src="{{ url_for('static', filename='js/admin_taxonomy_picker.js') }}"></script>
    </form>

    <div class="ppx-card" style="position: sticky; bottom: 0; margin-top:16px; padding:12px; display:flex; align-items:center; justify-content:space-between; gap:12px; max-width:1000px;">
      <div class="ppx-row" style="gap:8px;">
        <button id="ppx-save-draft" type="button" class="ppx-btn">{{ t('Guardar borrador', 'Save draft', app_lang) }}</button>
        <button id="ppx-preview" type="button" class="ppx-btn ppx-btn--primary">{{ t('Vista previa', 'Preview', app_lang) }}</button>
        <button id="ppx-export-json" type="button" class="ppx-btn">{{ t('Exportar JSON', 'Export JSON', app_lang) }}</button>
      </div>
      <div class="ppx-row" style="gap:8px;">
        <button id="ppx-publish" type="button" class="ppx-btn ppx-btn--ok" disabled>{{ t('Publicar', 'Publish', app_lang) }}</button>
      </div>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    window.PPX_BUILDER = {
      mode: "{{ builder_mode|default('new') }}",
      slug: "{{ builder_slug|default('') }}"
    };
  </script>
  <script defer src="{{ url_for('static', filename='js/ppx-json-editor.js') }}?v=20251122a"></script>
  <script defer src="{{ url_for('static', filename='js/admin_builder_mcq.js') }}?v=20251117a"></script>
{% endblock %}


