{% extends 'admin_index.html' %}
{% block title %}Edit Lesson{% endblock %}

{% block head %}
  <style>
    .builder-shell{display:grid;grid-template-columns:240px 1fr 320px;gap:12px}
    .builder-palette,.builder-canvas,.builder-inspector{border:1px solid #eee;border-radius:10px;padding:12px;background:#fff}
    .builder-canvas{min-height:400px}
  </style>
{% endblock %}

{% block content %}
<section class="builder-shell" data-lesson-id="{{ lesson.id if lesson else '' }}">
  <aside class="builder-palette">
    {% if lesson %}
      <h3>Slides</h3>
      <div id="slides-list" class="ppx-stack-sm">
        {% set slides = (lesson.json or {}).get('slides', []) %}
        {% for s in slides %}
          <div class="ppx-row" style="justify-content:space-between;align-items:center;" draggable="true" data-idx="{{ loop.index0 }}">
            <button class="ppx-pill" type="button">{{ loop.index }}. {{ s.get('mode', s.get('type','slide')) }}</button>
            <div class="ppx-row" style="gap:6px;">
              <button class="ppx-pill" type="button">↑</button>
              <button class="ppx-pill" type="button">↓</button>
              <button class="ppx-pill" type="button">⧉</button>
              <button class="ppx-pill" type="button">✕</button>
            </div>
          </div>
        {% else %}
          <div class="ppx-muted">No slides yet.</div>
        {% endfor %}
      </div>
      <div class="ppx-stack-sm" style="margin-top:10px;">
        <button id="add-content" class="ppx-pill" type="button">+ Add Content</button>
        <button id="add-mcq" class="ppx-pill" type="button">+ Add MCQ</button>
        <button id="add-tf" class="ppx-pill" type="button">+ Add True/False</button>
        <button id="add-tapword" class="ppx-pill" type="button">+ Add Tap-Word</button>
        <button id="add-dragblank" class="ppx-pill" type="button">+ Add Drag-Blank</button>
        <button id="add-flash" class="ppx-pill" type="button">+ Add Flashcard</button>
      </div>
    {% else %}
      <h3>Elements</h3>
      <button data-el="text">Text</button>
      <button data-el="audio">Audio</button>
      <button data-el="mcq">MCQ</button>
      <button data-el="tf">True/False</button>
      <button data-el="tapword">Tap Word</button>
      <button data-el="dragblank">Drag Blank</button>
      <button data-el="dictation">Dictation</button>
      <button data-el="flashcard">Flashcard</button>
    {% endif %}
  </aside>
  <main class="builder-canvas">
    <h3>Live Preview</h3>
    <div class="ppx-row" style="justify-content:flex-end;align-items:center;margin-bottom:8px;gap:6px;">
      <button class="ppx-pill" id="btn-refresh-preview" type="button">Refresh Preview</button>
      <a class="ppx-pill" id="btn-open-player" href="{{ url_for('lessons_public.lesson_player', slug=lesson.slug) if lesson else '#' }}" target="_blank" rel="noopener">Open Player</a>
    </div>
    <iframe class="builder-preview" title="Preview" style="width:100%;height:600px;border:0" src="{% if lesson %}/lessons/{{ lesson.slug }}?edit=1&id={{ lesson.id }}{% endif %}"></iframe>
  </main>
  <aside class="builder-inspector">
    <h3>Inspector</h3>
    <form method="post" action="{% if not lesson %}{{ url_for('admin.lessons_create') }}{% else %}#{% endif %}">
      <label>Title<br><input name="title" class="ppx-input" value="{{ lesson.title if lesson else '' }}" required></label>
      <label>Locale<br><input name="locale" class="ppx-input" value="{{ lesson.locale if lesson else 'es' }}" required></label>
      {% if not lesson %}
      <button class="btn-save" type="submit">Create</button>
      {% endif %}
    </form>
    <div class="inspector-fields">Select a slide to edit properties.</div>
    <hr>
    <div class="builder-actions">
      <button class="btn-save">Save Draft</button>
      <button class="btn-review">Submit for Review</button>
      <button class="btn-publish">Publish</button>
    </div>
  </aside>
</section>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script type="module" src="{{ static_ver('js/admin_lessons_builder/index.js') }}"></script>
  <script>
    // Fallback loader in case a cached copy prevented execution
    (function(){
      setTimeout(function(){
        try{
          if(!window.lessons_builder_loaded){
            var s=document.createElement('script');
            s.type='module';
            s.src='{{ url_for('static', filename='js/admin_lessons_builder/index.js') }}?bust=' + Date.now();
            document.currentScript.parentNode.appendChild(s);
          }
        }catch(_){/* no-op */}
      }, 50);
    })();
  </script>
{% endblock %}
