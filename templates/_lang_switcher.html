<!-- templates/_lang_switcher.html -->
{% set _is_admin = request.path.startswith('/admin') %}
{% set _cur = (app_lang or 'es') %}
{% set _opts = lang_options or [] %}

<span class="ppx-lang-switcher" style="position:relative;display:inline-flex;">
  <button type="button"
          class="ppx-btn"
          id="ppx-lang-btn"
          aria-haspopup="listbox"
          aria-expanded="false"
          aria-label="{{ t('Cambiar idioma', 'Change language', app_lang) }}"
          style="display:inline-flex;align-items:center;gap:.4rem;border:1px solid var(--ppx-color-line,#e5e7eb);border-radius:999px;padding:.35rem .6rem;background:#fff;">
    <span aria-hidden="true" style="width:18px;height:18px;display:inline-block;background:currentColor;opacity:.9;-webkit-mask:url('data:image/svg+xml;utf8,<svg viewBox=\'0 0 24 24\' xmlns=\'http://www.w3.org/2000/svg\'><path d=\'M12 2a10 10 0 100 20 10 10 0 000-20zm7.93 9h-3.11a15.87 15.87 0 00-1.06-5.02A8.03 8.03 0 0119.93 11zM12 4c.94 1.27 1.72 3.13 2.1 5H9.9c.38-1.87 1.16-3.73 2.1-5zM6.24 5.98A15.87 15.87 0 005.18 11H2.07a8.03 8.03 0 014.17-5.02zM2.07 13h3.11c.18 1.76.64 3.45 1.06 5.02A8.03 8.03 0 012.07 13zM12 20c-.94-1.27-1.72-3.13-2.1-5h4.2c-.38 1.87-1.16 3.73-2.1 5zm5.76-1.98A15.87 15.87 0 0018.82 13h3.11a8.03 8.03 0 01-4.17 5.02zM8.28 13h7.44c-.2 1.73-.66 3.42-1.2 4.83H9.48c-.54-1.41-1-3.1-1.2-4.83zm7.44-2H8.28c.2-1.73.66-3.42 1.2-4.83h5.04c.54 1.41 1 3.1 1.2 4.83z\' fill=\'%23000\'/></svg>') center/contain no-repeat;mask:url('data:image/svg+xml;utf8,<svg viewBox=\'0 0 24 24\' xmlns=\'http://www.w3.org/2000/svg\'><path d=\'M12 2a10 10 0 100 20 10 10 0 000-20zm7.93 9h-3.11a15.87 15.87 0 00-1.06-5.02A8.03 8.03 0 0119.93 11zM12 4c.94 1.27 1.72 3.13 2.1 5H9.9c.38-1.87 1.16-3.73 2.1-5zM6.24 5.98A15.87 15.87 0 005.18 11H2.07a8.03 8.03 0 014.17-5.02zM2.07 13h3.11c.18 1.76.64 3.45 1.06 5.02A8.03 8.03 0 012.07 13zM12 20c-.94-1.27-1.72-3.13-2.1-5h4.2c-.38 1.87-1.16 3.73-2.1 5zm5.76-1.98A15.87 15.87 0 0018.82 13h3.11a8.03 8.03 0 01-4.17 5.02zM8.28 13h7.44c-.2 1.73-.66 3.42-1.2 4.83H9.48c-.54-1.41-1-3.1-1.2-4.83zm7.44-2H8.28c.2-1.73.66-3.42 1.2-4.83h5.04c.54 1.41 1 3.1 1.2 4.83z\' fill=\'%23000\'/></svg>') center/contain no-repeat;"></span>
    <span style="font:600 12px/1 var(--ppx-font,'Montserrat',system-ui);">{{ _opts | selectattr('code','equalto',_cur) | list | first | default({'name_native': _cur.upper()}).name_native }}</span>
  </button>

  <ul id="ppx-lang-menu"
      class="ppx-card"
      role="listbox"
      tabindex="-1"
      aria-labelledby="ppx-lang-btn"
      style="position:absolute;top:calc(100% + 6px);right:0;min-width:220px;max-height:300px;overflow:auto;margin:0;padding:.35rem;list-style:none;border:1px solid var(--ppx-color-line,#e5e7eb);border-radius:12px;background:#fff;box-shadow:0 8px 24px rgba(0,0,0,.08);display:none;">
    {% for L in _opts %}
      {% set is_cur = (L.code == _cur) %}
      {% if _is_admin %}
        {% set _next = request.full_path or request.path %}
        {% set _href = '/admin/lang?set=' ~ L.code ~ '&next=' ~ _next|urlencode %}
      {% else %}
        {# keep existing query, but replace/append lang #}
        {% set _q = request.query_string.decode() if request.query_string else '' %}
        {% set _sep = '?' if not _q else '?' %}
        {% if _q %}
          {% set _q_pairs = _q.split('&') %}
          {% set _q_pairs = _q_pairs | reject('equalto','') | list %}
          {% set _q_pairs = (_q_pairs | reject('match','^lang=') | list) %}
          {% set _q = '&'.join(_q_pairs) %}
          {% set _href = request.path ~ (_sep ~ _q if _q else '?') ~ ('&' if _q else '') ~ 'lang=' ~ L.code %}
        {% else %}
          {% set _href = request.path ~ '?lang=' ~ L.code %}
        {% endif %}
      {% endif %}
      <li role="option" aria-selected="{{ 'true' if is_cur else 'false' }}">
        <a href="{{ _href }}"
           style="display:flex;align-items:center;justify-content:space-between;gap:.5rem;padding:.45rem .6rem;border-radius:8px;text-decoration:none;font:500 13px/1.2 var(--ppx-font,'Montserrat',system-ui);color:var(--ppx-color-text,#0f172a);{{ 'background:#eef2ff;' if is_cur else '' }}">
          <span>{{ L.name_native }}</span>
          <small style="opacity:.6;{{ 'font-weight:700;' if is_cur else '' }}">{{ L.code.upper() }}</small>
        </a>
      </li>
    {% endfor %}
  </ul>
</span>

<script>
(function(){
  var btn = document.getElementById('ppx-lang-btn');
  var menu = document.getElementById('ppx-lang-menu');
  if (!btn || !menu) return;

  function open(){ menu.style.display='block'; btn.setAttribute('aria-expanded','true'); }
  function close(){ menu.style.display='none'; btn.setAttribute('aria-expanded','false'); }
  function toggle(){ (menu.style.display==='block') ? close() : open(); }

  btn.addEventListener('click', function(e){ e.preventDefault(); toggle(); });
  document.addEventListener('click', function(e){
    if (!btn.contains(e.target) && !menu.contains(e.target)) close();
  });
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') close();
  });
})();
</script>
